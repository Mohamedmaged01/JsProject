<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel</title>
    <link rel="stylesheet" href="../styles/Admin.css" />
    <!-- Google Font: Poppins and Font Awesome -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css"
    />
    <style>
      /* Global Styles */
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
        color: #333;
      }
      a {
        text-decoration: none;
        color: inherit;
      }
      /* Header Styling */
      .header {
        background-color: #000;
        color: #fff;
        padding: 1rem 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
      .header .flex {
        display: flex;
        align-items: center;
        justify-content: space-between;
        max-width: 1200px;
        margin: 0 auto;
      }
      .header .logo {
        font-size: 1.8rem;
        font-weight: 600;
      }
      /* Admin Container */
      .admin-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 2rem;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      /* Admin Options */
      .admin-options {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
      }
      .admin-options button {
        background: #000;
        color: #fff;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        cursor: pointer;
        transition: background 0.3s ease;
      }
      .admin-options button:hover {
        background: #333;
      }
      /* Management Sections */
      .management-section {
        margin-bottom: 2rem;
      }
      .management-section h2 {
        border-bottom: 2px solid #000;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
      }
      form input,
      form textarea,
      form select {
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      form button {
        background: #000;
        color: #fff;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s ease;
      }
      form button:hover {
        background: #333;
      }
      /* Course Cost Radio Group */
      .course-cost-group {
        margin-bottom: 1rem;
      }
      .course-cost-group label {
        margin-right: 1.5rem;
        font-weight: 500;
      }
      #paidPriceContainer {
        margin-bottom: 1rem;
      }
      /* Lists and Tables */
      ul {
        list-style: none;
        padding: 0;
      }
      ul li {
        background: #e9e9e9;
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 4px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
      }
      table,
      th,
      td {
        border: 1px solid #ddd;
      }
      th,
      td {
        padding: 0.75rem;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="flex">
        <a href="home.html" class="logo">3lmny</a>
      </div>
    </header>

    <div class="admin-container">
      <h1>Admin Dashboard</h1>
      <div class="admin-options">
        <button onclick="manageCourses()">Manage Courses</button>
        <button onclick="manageCategories()">Manage Categories</button>
        <button onclick="manageStudents()">Manage Students</button>
        <button onclick="manageRegistrations()">Manage Registrations</button>
        <button onclick="logout()">Logout</button>
      </div>

      <div id="courseManagement" class="management-section active">
        <h2>Manage Courses</h2>
        <form id="courseForm">
          <input
            type="text"
            id="courseTitle"
            placeholder="Course Title"
            required
          />
          <input
            type="text"
            id="courseImage"
            placeholder="Image URL"
            required
          />
          <select id="courseCategory" required></select>
          <input
            type="text"
            id="courseInstructor"
            placeholder="Instructor Name"
            required
          />
          <textarea
            id="courseDescription"
            placeholder="Course Description"
            required
          ></textarea>

          <div class="course-cost-group">
            <label>
              <input type="radio" name="courseCost" value="free" checked /> Free
            </label>
            <label>
              <input type="radio" name="courseCost" value="paid" /> Paid
            </label>
          </div>

          <div id="paidPriceContainer" style="display: none">
            <input type="text" id="coursePaidPrice" placeholder="Enter Price" />
          </div>
          <input
            type="text"
            id="courseDuration"
            placeholder="Duration (e.g., 10 hours)"
            required
          />
          <input
            type="url"
            id="courseContent"
            placeholder="Content Link (Videos, PDFs, etc.)"
            required
          />
          <button type="submit" id="courseSubmitBtn">Add Course</button>
          <button type="button" id="cancelEditBtn" style="display: none">
            Cancel Edit
          </button>
        </form>
        <ul id="courseList"></ul>
      </div>

      <div id="categoryManagement" class="management-section">
        <h2>Manage Categories</h2>
        <form id="categoryForm">
          <input
            type="text"
            id="categoryName"
            placeholder="Category Name"
            required
          />
          <button type="submit">Add Category</button>
        </form>
        <ul id="categoryList"></ul>
      </div>

      <div id="studentManagement" class="management-section">
        <h2>Manage Students</h2>
        <table id="studentTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Enrolled Courses</th>
            </tr>
          </thead>
          <tbody>
            <!-- Students and their progress will be populated dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Registration Management Section -->
      <div id="registrationManagement" class="management-section">
        <h2>Manage Registrations</h2>
        <table id="registrationTable">
          <thead>
            <tr>
              <th>Student</th>
              <th>Course</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Registration requests will be populated dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // ===============================
      // Helper Functions for Local Storage
      // ===============================
      const getData = (key) => {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
      };

      const saveData = (key, data) => {
        localStorage.setItem(key, JSON.stringify(data));
      };

      // ===============================
      // Initialization
      // ===============================
      const initializeLocalStorage = () => {
        if (!localStorage.getItem("courses")) saveData("courses", []);
        if (!localStorage.getItem("categories")) saveData("categories", []);
        if (!localStorage.getItem("students")) saveData("students", []);
        if (!localStorage.getItem("registrations"))
          saveData("registrations", []);
      };

      initializeLocalStorage();

      let editingCourseId = null;

      const renderCourses = () => {
        const courses = getData("courses");
        const courseList = document.getElementById("courseList");
        courseList.innerHTML = courses
          .map(
            (course) => `
          <li>
            <strong>${course.title}</strong> by ${course.instructor} - ${course.description}
            <br>
            Price: ${course.price} | Duration: ${course.duration} | Content: <a href="${course.content}" target="_blank">${course.content}</a>
            <br>
            <button onclick="editCourse(${course.id})">Edit</button>
            <button onclick="deleteCourse(${course.id})">Delete</button>
          </li>
        `
          )
          .join("");
      };

      const renderCategories = () => {
        const categories = getData("categories");
        const categoryList = document.getElementById("categoryList");
        categoryList.innerHTML = categories
          .map(
            (category) => `
          <li>
            ${category.name}
            <button onclick="deleteCategory(${category.id})">Delete</button>
          </li>
        `
          )
          .join("");
        populateCourseCategorySelect();
      };

      const populateCourseCategorySelect = () => {
        const categories = getData("categories");
        const courseCategorySelect = document.getElementById("courseCategory");
        let optionsHTML = `<option value="">Select Category</option>`;
        categories.forEach((category) => {
          optionsHTML += `<option value="${category.id}">${category.name}</option>`;
        });
        courseCategorySelect.innerHTML = optionsHTML;
      };

      const renderStudents = () => {
        const students = getData("students");
        const studentTableBody = document
          .getElementById("studentTable")
          .querySelector("tbody");
        studentTableBody.innerHTML = students
          .map((student) => {
            const enrolledKey = "enrolledCourses_" + student.email;
            const enrolledCourses = getData(enrolledKey);
            const courseTitles = enrolledCourses.length
              ? enrolledCourses.map((c) => c.title).join(", ")
              : "No courses enrolled";
            return `
          <tr>
            <td>${student.name}</td>
            <td>${student.email}</td>
            <td>${courseTitles}</td>
          </tr>
        `;
          })
          .join("");
      };

      const renderRegistrations = () => {
        const registrations = getData("registrations");
        const registrationTableBody = document
          .getElementById("registrationTable")
          .querySelector("tbody");
        registrationTableBody.innerHTML = registrations
          .map(
            (registration) => `
          <tr>
            <td>${registration.studentId}</td>
            <td>${registration.courseId}</td>
            <td>${registration.status}</td>
            <td>
              <button onclick="approveRegistration(${registration.id})">Approve</button>
              <button onclick="rejectRegistration(${registration.id})">Reject</button>
            </td>
          </tr>
        `
          )
          .join("");
      };

      // ===============================
      // Delete Functions
      // ===============================
      const deleteCourse = (courseId) => {
        let courses = getData("courses");
        courses = courses.filter((course) => course.id !== courseId);
        saveData("courses", courses);
        renderCourses();
      };

      const deleteCategory = (categoryId) => {
        let categories = getData("categories");
        categories = categories.filter(
          (category) => category.id !== categoryId
        );
        saveData("categories", categories);
        renderCategories();
      };

      document.getElementById("courseForm").addEventListener("submit", (e) => {
        e.preventDefault();

        const title = document.getElementById("courseTitle").value.trim();
        const image = document.getElementById("courseImage").value.trim();
        const categoryId = document.getElementById("courseCategory").value;
        const instructor = document
          .getElementById("courseInstructor")
          .value.trim();
        const description = document
          .getElementById("courseDescription")
          .value.trim();
        const duration = document.getElementById("courseDuration").value.trim();
        const content = document.getElementById("courseContent").value.trim();

        if (
          !title ||
          !image ||
          !categoryId ||
          !instructor ||
          !description ||
          !duration ||
          !content
        ) {
          alert("All fields are required.");
          return;
        }

        const costRadios = document.querySelector(
          'input[name="courseCost"]:checked'
        );
        const courseCost = costRadios.value;
        let finalPrice;
        if (courseCost === "free") {
          finalPrice = "free";
        } else {
          const paidPriceValue = document
            .getElementById("coursePaidPrice")
            .value.trim();
          if (!paidPriceValue) {
            alert("Please enter a price for the paid course.");
            return;
          }
          const numericPrice = Number(paidPriceValue);
          if (isNaN(numericPrice) || numericPrice <= 0) {
            alert(
              "Invalid price value. Please enter a positive number for the course price."
            );
            return;
          }
          finalPrice = numericPrice;
        }

        let courses = getData("courses");

        if (editingCourseId !== null) {
          const courseIndex = courses.findIndex(
            (course) => course.id === editingCourseId
          );
          if (courseIndex === -1) {
            alert("Course not found.");
            return;
          }
          courses[courseIndex] = {
            ...courses[courseIndex],
            title,
            image,
            categoryId,
            instructor,
            description,
            price: finalPrice,
            duration,
            content,
          };
          alert("Course updated successfully.");
          editingCourseId = null;
          document.getElementById("courseSubmitBtn").textContent = "Add Course";
          document.getElementById("cancelEditBtn").style.display = "none";
        } else {
          const duplicate = courses.some(
            (course) => course.title.toLowerCase() === title.toLowerCase()
          );
          if (duplicate) {
            alert("A course with this title already exists.");
            return;
          }
          const newCourse = {
            id: Math.floor(Math.random() * 10000),
            title,
            image,
            categoryId,
            instructor,
            description,
            price: finalPrice,
            duration,
            content,
          };
          courses.push(newCourse);
          alert("Course added successfully.");
        }

        saveData("courses", courses);
        renderCourses();
        document.getElementById("courseForm").reset();
        document.getElementById("courseSubmitBtn").textContent = "Add Course";
        document.getElementById("cancelEditBtn").style.display = "none";
        document.getElementById("paidPriceContainer").style.display = "none";
      });

      document
        .getElementById("categoryForm")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const categoryName = document
            .getElementById("categoryName")
            .value.trim();
          if (!categoryName) {
            alert("Category name cannot be empty.");
            return;
          }
          let categories = getData("categories");
          const duplicate = categories.some(
            (cat) => cat.name.toLowerCase() === categoryName.toLowerCase()
          );
          if (duplicate) {
            alert("This category already exists.");
            return;
          }
          const newCategory = {
            id: Math.floor(Math.random() * 10000),
            name: categoryName,
          };
          categories.push(newCategory);
          saveData("categories", categories);
          renderCategories();
        });

      // ===============================
      // Cancel Edit Handler
      // ===============================
      document.getElementById("cancelEditBtn").addEventListener("click", () => {
        editingCourseId = null;
        document.getElementById("courseForm").reset();
        document.getElementById("courseSubmitBtn").textContent = "Add Course";
        document.getElementById("cancelEditBtn").style.display = "none";
        document.getElementById("paidPriceContainer").style.display = "none";
      });

      // ===============================
      // Price Radio Button Change Listener
      // ===============================
      document.querySelectorAll('input[name="courseCost"]').forEach((radio) => {
        radio.addEventListener("change", function () {
          document.getElementById("paidPriceContainer").style.display =
            this.value === "paid" ? "block" : "none";
        });
      });

      function requestRegistration(courseId) {
        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
        if (!loggedInUser) {
          alert("Please login first to enroll in courses.");
          return;
        }
        let registrations = getData("registrations");
        const existingRequest = registrations.find(
          (r) =>
            r.courseId === courseId &&
            r.studentId === loggedInUser.email &&
            (r.status === "pending" || r.status === "approved")
        );
        if (existingRequest) {
          alert(
            existingRequest.status === "pending"
              ? "Your registration request for this course is already pending."
              : "You are already enrolled in this course."
          );
          return;
        }
        const regId = Math.floor(Math.random() * 10000);
        const registration = {
          id: regId,
          studentId: loggedInUser.email,
          courseId: courseId,
          status: "pending",
        };
        registrations.push(registration);
        saveData("registrations", registrations);
        alert(
          "Registration request submitted. Your request is now pending approval."
        );
        renderCourses();
      }

      function approveRegistration(registrationId) {
        let registrations = getData("registrations");
        const regIndex = registrations.findIndex(
          (r) => r.id === registrationId
        );
        if (regIndex === -1) {
          alert("Registration not found.");
          return;
        }
        registrations[regIndex].status = "approved";
        saveData("registrations", registrations);

        const studentId = registrations[regIndex].studentId;
        const courseId = registrations[regIndex].courseId;
        const courses = getData("courses");
        const courseToEnroll = courses.find((c) => c.id === courseId);
        if (!courseToEnroll) {
          alert("Course not found.");
          return;
        }
        const enrolledKey = "enrolledCourses_" + studentId;
        let enrolledCourses = getData(enrolledKey);
        if (!enrolledCourses.some((c) => c.id === courseId)) {
          enrolledCourses.push(courseToEnroll);
          saveData(enrolledKey, enrolledCourses);
        }
        alert("Registration approved and course added to enrolled courses.");
        renderRegistrations();
      }
      function rejectRegistration(registrationId) {
        let registrations = getData("registrations");
        const regIndex = registrations.findIndex(
          (r) => r.id === registrationId
        );
        if (regIndex === -1) {
          alert("Registration not found.");
          return;
        }
        registrations[regIndex].status = "rejec.ted";
        saveData("registrations", registrations);
        alert("Registration rejected.");
        renderRegistrations();
      }
      function manageCourses() {
        document.getElementById("courseManagement").style.display = "block";
        document.getElementById("categoryManagement").style.display = "none";
        document.getElementById("studentManagement").style.display = "none";
        document.getElementById("registrationManagement").style.display =
          "none";
      }
      function manageCategories() {
        document.getElementById("courseManagement").style.display = "none";
        document.getElementById("categoryManagement").style.display = "block";
        document.getElementById("studentManagement").style.display = "none";
        document.getElementById("registrationManagement").style.display =
          "none";
      }
      function manageStudents() {
        document.getElementById("courseManagement").style.display = "none";
        document.getElementById("categoryManagement").style.display = "none";
        document.getElementById("studentManagement").style.display = "block";
        document.getElementById("registrationManagement").style.display =
          "none";
        renderStudents();
      }
      function manageRegistrations() {
        document.getElementById("courseManagement").style.display = "none";
        document.getElementById("categoryManagement").style.display = "none";
        document.getElementById("studentManagement").style.display = "none";
        document.getElementById("registrationManagement").style.display =
          "block";
        renderRegistrations();
      }

      const logout = () => {
        localStorage.removeItem("token");
        localStorage.removeItem("loggedInUser");
        window.location.href = "first.html";
      };

      function filterAndDisplayCourses() {
        let courses = getData("courses");
        const searchQuery = document
          .getElementById("search-box")
          .value.trim()
          .toLowerCase();
        const selectedCategory =
          document.getElementById("category-filter").value;
        const selectedPrice = document.getElementById("price-filter").value;
        let filteredCourses = courses;
        if (searchQuery !== "") {
          filteredCourses = filteredCourses.filter(
            (course) =>
              course.title.toLowerCase().includes(searchQuery) ||
              course.description.toLowerCase().includes(searchQuery) ||
              (course.tutor && course.tutor.toLowerCase().includes(searchQuery))
          );
        }
        if (selectedCategory !== "") {
          filteredCourses = filteredCourses.filter(
            (course) => course.categoryId == selectedCategory
          );
        }
        if (selectedPrice !== "") {
          filteredCourses = filteredCourses.filter(
            (course) => course.price === selectedPrice
          );
        }
        displayCourses(filteredCourses);
      }

      document
        .getElementById("search-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          filterAndDisplayCourses();
        });
      document
        .getElementById("category-filter")
        .addEventListener("change", filterAndDisplayCourses);
      document
        .getElementById("price-filter")
        .addEventListener("change", filterAndDisplayCourses);
      const courses = getData("courses");
      renderCourses();
      renderCategories();
      renderStudents();
      renderRegistrations();
      populateCourseCategorySelect();
      populateCourseCategorySelect();
    </script>
  </body>
</html>
